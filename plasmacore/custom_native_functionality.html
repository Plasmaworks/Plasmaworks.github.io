<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Content generated by Mediawiki and mw2html -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta http-equiv="Content-Style-Type" content="text/css" />
		<meta name="generator" content="MediaWiki 1.15.1" />
		<meta name="keywords" content="Custom Native Functionality" />
		<link rel="shortcut icon" href="http://plasmaworks.com/sites/default/files/sky_favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="Plasmaworks (en)" />
		<link rel="alternate" type="application/rss+xml" title="Plasmaworks RSS Feed" href="" />
		<link rel="alternate" type="application/atom+xml" title="Plasmaworks Atom Feed" href="" />
		<title>Custom Native Functionality - Plasmaworks</title>
		<link rel="stylesheet" href="shared.css" type="text/css" media="screen" />
		<link rel="stylesheet" href="commonprint.css" type="text/css" media="print" />
		<link rel="stylesheet" href="main.css" type="text/css" media="screen" />
		<!--[if lt IE 5.5000]><link rel="stylesheet" href="ie50fixes.css" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 5.5000]><link rel="stylesheet" href="ie55fixes.css" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 6]><link rel="stylesheet" href="ie60fixes.css" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 7]><link rel="stylesheet" href="ie70fixes.css" type="text/css" media="screen" /><![endif]-->
		<link rel="stylesheet" href="" type="text/css" />
		<link rel="stylesheet" href="" type="text/css" media="print" />
		<link rel="stylesheet" href="" type="text/css" />
		<link rel="stylesheet" href="" type="text/css" />
		<!--[if lt IE 7]><script type="text/javascript" src="iefixes.js_207"></script>
		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->

		<script type= "text/javascript">/*<![CDATA[*/
		var skin = "monobook";
		var stylepath = "/wiki/skins";
		var wgArticlePath = "/wiki/index.php/$1";
		var wgScriptPath = "/wiki";
		var wgScript = "/wiki/index.php";
		var wgVariantArticlePath = false;
		var wgActionPaths = {};
		var wgServer = "http://www.plasmaworks.com";
		var wgCanonicalNamespace = "";
		var wgCanonicalSpecialPageName = false;
		var wgNamespaceNumber = 0;
		var wgPageName = "Custom_Native_Functionality";
		var wgTitle = "Custom Native Functionality";
		var wgAction = "view";
		var wgArticleId = "13";
		var wgIsArticle = true;
		var wgUserName = null;
		var wgUserGroups = null;
		var wgUserLanguage = "en";
		var wgContentLanguage = "en";
		var wgBreakFrames = false;
		var wgCurRevisionId = 1088;
		var wgVersion = "1.15.1";
		var wgEnableAPI = true;
		var wgEnableWriteAPI = true;
		var wgSeparatorTransformTable = ["", ""];
		var wgDigitTransformTable = ["", ""];
		var wgRestrictionEdit = [];
		var wgRestrictionMove = [];
		/*]]>*/</script>

		<script type="text/javascript" src="wikibits.js_207"><!-- wikibits js --></script>
		<!-- Head Scripts -->
		<script type="text/javascript" src="ajax.js_207"></script>
		<script type="text/javascript" src=""><!-- site js --></script>
	</head>
<body class="mediawiki ltr ns-0 ns-subject page-Custom_Native_Functionality skin-monobook">
	<div id="globalWrapperHacked">
		<div id="column-content">
	<div id="content">
		<a name="top" id="top"></a>
				<h1 id="firstHeading" class="firstHeading">Custom Native Functionality</h1>
		<div id="bodyContent">
			<h3 id="siteSub">From Plasmaworks</h3>
			<div id="contentSub"></div>
									<div id="jump-to-nav">Jump to: <a href="#column-one">navigation</a>, <a href="#searchInput">search</a></div>			<!-- start content -->
			<table id="toc" class="toc" summary="Contents"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1"><a href="#Overview"><span class="tocnumber">1</span> <span class="toctext">Overview</span></a></li>
<li class="toclevel-1"><a href="#Preparation"><span class="tocnumber">2</span> <span class="toctext">Preparation</span></a></li>
<li class="toclevel-1"><a href="#perform_custom_setup.28.29"><span class="tocnumber">3</span> <span class="toctext">perform_custom_setup()</span></a></li>
<li class="toclevel-1"><a href="#Native_Methods"><span class="tocnumber">4</span> <span class="toctext">Native Methods</span></a>
<ul>
<li class="toclevel-2"><a href="#Caveats"><span class="tocnumber">4.1</span> <span class="toctext">Caveats</span></a>
<ul>
<li class="toclevel-3"><a href="#Forgetting_to_pop_a_parameter_or_push_a_result"><span class="tocnumber">4.1.1</span> <span class="toctext">Forgetting to pop a parameter or push a result</span></a></li>
</ul>
</li>
</ul>
</li>
<li class="toclevel-1"><a href="#Native_Data"><span class="tocnumber">5</span> <span class="toctext">Native Data</span></a></li>
</ul>
</td></tr></table><script type="text/javascript"> if (window.showTocToggle) { var tocShowText = "show"; var tocHideText = "hide"; showTocToggle(); } </script>
<a name="Overview" id="Overview"></a><h2> <span class="mw-headline"> Overview </span></h2>
<p>There are three ways to add additional native functionality and interoperability to your Plasmacore projects:
</p>
<ol><li> By defining native methods that are called from Slag and implemented in C++ (or the native language of the current platform).
</li><li> By calling Slag methods from native code.
</li><li> By storing native data in Slag objects.
</li></ol>
<p>Native functionality can be "hooked in" by modifying the <i>perform_custom_setup()</i> method in the main file of a Plasmacore platform implementation - for example, in platforms/ios/main.mm or platforms/windows/main.cpp.  These main files are intended for your use and modification - the GoGo build system will create them if they are missing, but it will never overwrite them while upgrading a project.  And yes, Mac and Windows users will need to recompile Plasmacore to take advantage of custom functionality.
</p>
<a name="Preparation" id="Preparation"></a><h2> <span class="mw-headline"> Preparation </span></h2>
<p>Edit the main native file (main.cpp, main.mm, etc.), #include or #import whatever files you need, add the appropriate .cpp/.m/.mm files (concerned with what functionality you're adding) to the project.
</p>
<a name="perform_custom_setup.28.29" id="perform_custom_setup.28.29"></a><h2> <span class="mw-headline"> perform_custom_setup() </span></h2>
<p>In <i>perform_custom_setup()</i> you will want to do any mix of the following:
</p><p>1.  Call appropriate library initialization routines.
</p><p>2.  Add custom shutdown callbacks to clean up your libraries at program exit (not usually required):
</p>
<pre>   void my_shutdown_fn() { ... }
 
   void perform_custom_setup()
   {
     slag_add_custom_shutdown( my_shutdown_fn );
     ...
   }
</pre>
<p>3. Hook up native method implementations (see below).
</p>
<a name="Native_Methods" id="Native_Methods"></a><h2> <span class="mw-headline"> Native Methods </span></h2>
<p>Say that you augmented Math with the following method:
</p>
<pre> augment Math
   native method hypotenuse( Real64 width, Real64 height ).Real64
 endAugment
</pre>
<p>You would write your native implementation like this, making sure your
signature conforms to the same signature pattern so that a cross-compiled
build will work with your method:
</p>
<pre> void Math__hypotenuse__Real64_Real64()
 {
   // pop the parameters
   SlagReal64 height = SLAG_POP_REAL64();
   SlagReal64 width  = SLAG_POP_REAL64();
   SLAG_POP_REF();  // Discard the Math singleton
 
   // push the result
   SLAG_PUSH_REAL64( sqrt(width*width + height*height) );
 }
</pre>
<p>Then hook it up in <i>perform_custom_setup()</i>:
</p>
<pre> slag_hook_native( "Math", "hypotenuse(Real64,Real64)", Math__hypotenuse__Real64_Real64 );
</pre>
<a name="Caveats" id="Caveats"></a><h3> <span class="mw-headline"> Caveats </span></h3>
<p>There is one common mistake that is often made while implementing native layer methods.
</p>
<a name="Forgetting_to_pop_a_parameter_or_push_a_result" id="Forgetting_to_pop_a_parameter_or_push_a_result"></a><h4> <span class="mw-headline"> Forgetting to pop a parameter or push a result </span></h4>
<p>Make sure that you pop each parameter off the stack, <b>including</b> the object context itself - so if you call a method on the Math singleton that takes an integer parameter, be sure to pop off both the integer and the Math object reference.
</p><p>Forgetting to pop a parameter won't affect the VM build but it will tend to crash the cross-compiled builds.
</p><p>Likewise be sure that you always push a result (if required) onto the stack before returning from the native layer.
</p>
<a name="Native_Data" id="Native_Data"></a><h2> <span class="mw-headline"> Native Data </span></h2>
<p>Slag has a special mechanism for keeping native data (such as file handles or texture info) associated with Slag objects.  On the Slag-side you define a reference property of type "NativeData" which is an opaque "black box". On the native side you call SlagNativeData::create(arbitrary_pointer,delete_fn), where delete_fn is a function pointer that takes a void* as a parameter and is called when the native data object is collected.  This returns a SlagObject* reference to the native data.
</p><p>An easy way to use this system is to use the built-in "SlagResource" system as shown below.  As a toy example we're going to implement a native data struct that stores a C string and its length.
</p><p>First, define a C++ struct in the main file or a file included from the main file that extends the existing SlagResource struct, giving it any arbitrary methods and member variables you like:
</p>
<pre> struct CStringData&nbsp;: SlagResource
 {
   char* data;
   int count;
 
   CStringData( const char* st )
   {
     count = strlen(st);
     data = new char[count+1];
     strcpy(data,st);
   }
 
   ~CStringData() { delete data; }
 };
</pre>
<p>Second, create a Slag wrapper class containing a NativeData reference:
</p>
<pre> class CString
   PROPERTIES
     native_data&nbsp;: NativeData
 
   METHODS
     native method init( String data )
     native method get( int index ).Char
     native method count.Int32
 endClass
</pre>
<p>Next, here's a native implementation of CString::init(String) that creates a CStringData object and stores it in native_data:
</p>
<pre> void CString__init__String()
 {
   SlagString* param_obj = (SlagString*) SLAG_POP_REF();
   SlagObject* this_ref = SLAG_POP_REF();
 
   // Retrieve the String as an ASCII string and create the CStringData.
   char* st = param_obj-&gt;to_new_ascii();
   CStringData* data = new CStringData(st);
   delete st;
 
   // Create the native data.
   SlagNativeData* native_data_obj = SlagNativeData::create( data, SlagNativeDataDeleteResource );
   
   // Set the <i>native_data</i> reference of the Slag object.
   SLAG_SET_REF( this_obj, "native_data", native_data_obj );
 }
</pre>
<p>And finally, here's a native implementation of CString::get(Int32) that fetches the <i>native_data</i> reference while casting its <i>data</i> to a CStringData pointer and returns the requested character:
</p>
<pre> void CString__get__Int32()
 {
   SlagInt32 index = SLAG_POP_INT32();
   SlagObject* this_obj = SLAG_POP_REF();
 
   SLAG_GET_NATIVE_DATA( CStringData*, cstringdata, this_obj, "native_data" );
   if ( cstringdata &amp;&amp; index &gt;= 0 &amp;&amp; index &lt; cstringdata-&gt;count )
   {
     SLAG_PUSH_CHAR( cstringdata-&gt;data[index] );
   }
   else
   {
     SLAG_PUSH_CHAR(0); 
   }
 }
</pre>
<p>Add a similar implementation of CString::count() and you're done!  The CStringData will be automatically deleted by the end of the program.
</p>
<!-- 
NewPP limit report
Preprocessor node count: 8/1000000
Post-expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Expensive parser function count: 0/100
-->

<!-- Saved in parser cache with key pw_mediawiki_user:pcache:idhash:13-0!1!0!!en!2!edit=0 and timestamp 20120628114707 -->
<div class="printfooter">
Retrieved from "<a href="">http://www.plasmaworks.com/wiki/index.php/Custom_Native_Functionality</a>"</div>
						<!-- end content --><div class="visualClear"></div></div></div></div>
    <div id="column-one">
      <div id="p-cactions" class="portlet"></div>
      <div class="portlet" id="p-personal"></div>
      <div class="portlet" id="p-logo"></div>
      <div class="portlet" id="p-nav">
  
      </div>
      <div id="p-search" class="portlet"></div>
      <div class="portlet" id="p-tb"></div>
    </div>
    <!-- end left column -->
  <!-- end of the left (by default at least) column -->
			<div class="visualClear"></div>
			<div id="footerHacked">
				<ul id="f-list">
					<li id="lastmod"> This page was last modified on 14 July 2011, at 01:23.</li>
					<li id="viewcount">This page has been accessed 3,194 times.</li>
					<li id="privacy"><a href="plasmaworks_privacy_policy.html" title="Plasmaworks:Privacy policy">Privacy policy</a></li>
					<li id="about"><a href="plasmaworks_about.html" title="Plasmaworks:About">About Plasmaworks</a></li>
					<li id="disclaimer"><a href="plasmaworks_general_disclaimer.html" title="Plasmaworks:General disclaimer">Disclaimers</a></li>
			</ul>
		</div>
</div>

		<script type="text/javascript">if (window.runOnloadHook) runOnloadHook();</script>
<!-- Served in 0.284 secs. --><br></body></html>
