<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!-- Content generated by Mediawiki and mw2html -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en" dir="ltr">
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
		<meta http-equiv="Content-Style-Type" content="text/css" />
		<meta name="generator" content="MediaWiki 1.15.1" />
		<meta name="keywords" content="Slag:Advanced ForEach" />
		<link rel="shortcut icon" href="http://plasmaworks.com/sites/default/files/sky_favicon.ico" />
		<link rel="search" type="application/opensearchdescription+xml" href="opensearch_desc.php" title="Plasmaworks (en)" />
		<link rel="alternate" type="application/rss+xml" title="Plasmaworks RSS Feed" href="" />
		<link rel="alternate" type="application/atom+xml" title="Plasmaworks Atom Feed" href="" />
		<title>Slag:Advanced ForEach - Plasmaworks</title>
		<link rel="stylesheet" href="shared.css" type="text/css" media="screen" />
		<link rel="stylesheet" href="commonprint.css" type="text/css" media="print" />
		<link rel="stylesheet" href="main.css" type="text/css" media="screen" />
		<!--[if lt IE 5.5000]><link rel="stylesheet" href="ie50fixes.css" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 5.5000]><link rel="stylesheet" href="ie55fixes.css" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 6]><link rel="stylesheet" href="ie60fixes.css" type="text/css" media="screen" /><![endif]-->
		<!--[if IE 7]><link rel="stylesheet" href="ie70fixes.css" type="text/css" media="screen" /><![endif]-->
		<link rel="stylesheet" href="" type="text/css" />
		<link rel="stylesheet" href="" type="text/css" media="print" />
		<link rel="stylesheet" href="" type="text/css" />
		<link rel="stylesheet" href="" type="text/css" />
		<!--[if lt IE 7]><script type="text/javascript" src="iefixes.js_207"></script>
		<meta http-equiv="imagetoolbar" content="no" /><![endif]-->

		<script type= "text/javascript">/*<![CDATA[*/
		var skin = "monobook";
		var stylepath = "/wiki/skins";
		var wgArticlePath = "/wiki/index.php/$1";
		var wgScriptPath = "/wiki";
		var wgScript = "/wiki/index.php";
		var wgVariantArticlePath = false;
		var wgActionPaths = {};
		var wgServer = "http://www.plasmaworks.com";
		var wgCanonicalNamespace = "";
		var wgCanonicalSpecialPageName = false;
		var wgNamespaceNumber = 0;
		var wgPageName = "Slag:Advanced_ForEach";
		var wgTitle = "Slag:Advanced ForEach";
		var wgAction = "view";
		var wgArticleId = "41";
		var wgIsArticle = true;
		var wgUserName = null;
		var wgUserGroups = null;
		var wgUserLanguage = "en";
		var wgContentLanguage = "en";
		var wgBreakFrames = false;
		var wgCurRevisionId = 342;
		var wgVersion = "1.15.1";
		var wgEnableAPI = true;
		var wgEnableWriteAPI = true;
		var wgSeparatorTransformTable = ["", ""];
		var wgDigitTransformTable = ["", ""];
		var wgRestrictionEdit = [];
		var wgRestrictionMove = [];
		/*]]>*/</script>

		<script type="text/javascript" src="wikibits.js_207"><!-- wikibits js --></script>
		<!-- Head Scripts -->
		<script type="text/javascript" src="ajax.js_207"></script>
		<script type="text/javascript" src=""><!-- site js --></script>
	</head>
<body class="mediawiki ltr ns-0 ns-subject page-Slag_Advanced_ForEach skin-monobook">
	<div id="globalWrapperHacked">
		<div id="column-content">
	<div id="content">
		<a name="top" id="top"></a>
				<h1 id="firstHeading" class="firstHeading">Slag:Advanced ForEach</h1>
		<div id="bodyContent">
			<h3 id="siteSub">From Plasmaworks</h3>
			<div id="contentSub"></div>
									<div id="jump-to-nav">Jump to: <a href="#column-one">navigation</a>, <a href="#searchInput">search</a></div>			<!-- start content -->
			<p><br />
</p>
<table id="toc" class="toc" summary="Contents"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1"><a href="#Using_Custom_Objects_With_ForEach"><span class="tocnumber">1</span> <span class="toctext">Using Custom Objects With ForEach</span></a></li>
<li class="toclevel-1"><a href="#Concurrent_Modification_Errors_and_RemoveCurrent"><span class="tocnumber">2</span> <span class="toctext">Concurrent Modification Errors and RemoveCurrent</span></a></li>
</ul>
</td></tr></table><script type="text/javascript"> if (window.showTocToggle) { var tocShowText = "show"; var tocHideText = "hide"; showTocToggle(); } </script>
<a name="Using_Custom_Objects_With_ForEach" id="Using_Custom_Objects_With_ForEach"></a><h2> <span class="mw-headline"> Using Custom Objects With ForEach </span></h2>
<p>The standard way to have your own objects work with a <i>forEach</i> loop is to have your class incorporate the Readable&lt;&lt;ElementType&gt;&gt; aspect and define the method <i>create_reader()</i>.reader&lt;&lt;ElementType&gt;&gt;.  That method should return a new object that implements the Reader&lt;&lt;ElementType&gt;&gt; aspect.  Finally, that new reader object should respond to <i>has_another().Logical, peek().ElementType</i>, and <i>read().ElementType</i>.
</p><p>Here's an example of a Fibonacci class that's compatible with <i>forEach</i>.
</p>
<pre> class FibTest
   method init:
     forEach (n in FibonacciSequence(0,1,10)) println(n)
     # prints: 0 1 1 2 3 5 8 13 21 34
 
     println( FibonacciSequence(5,8,6) )
     # prints: {5,8,13,21,34,56}
 endClass
    
 class FibonacciSequence( Int64 first, Int64 second, Int32 count )&nbsp;: Readable&lt;&lt;Int64&gt;&gt;
   METHODS
     method create_reader.Reader&lt;&lt;Int64&gt;&gt;:
       return FibonacciReader(this)
 
     method to_String.String:
       return this.to_List.to_String
 endClass
  
 class FibonacciReader&nbsp;: Reader&lt;&lt;Int64&gt;&gt;
   PROPERTIES
     previous, current&nbsp;: Int64
     count&nbsp;: Int32
 
   METHODS
     method init( FibonacciSequence seq ):
       current = seq.first
       previous = seq.second - current
       count = seq.count
 
     method has_another.Logical:
       return count?
 
     method peek.Int64:
       if (count == 0) throw NoNextValueError()
       return current
 
     method read.Int64:
       if (count == 0) throw NoNextValueError()
       local var next = previous + current
       previous = current
       current = next
       --count
       return previous
 
 endClass
</pre>
<ul><li> Readable objects are designed to be read over and over again - if <i>create_reader()</i> is called on one two consecutive times, the reader object should return the same sequence of numbers both times.
</li></ul>
<ul><li> Reader objects are designed to be read only once.  The general philosophy is that they are created, read from, and then discarded.
</li></ul>
<ul><li> A "forEach (n in readable_obj)" call translates into the code similar to the following at compile time:
</li></ul>
<pre> local var reader = readable_obj.create_reader
 while (reader.has_another)
   local var n = reader.read
   ...
 endWhile
</pre>
<ul><li> A "forEach (n in reader_obj)" call translates into the code similar to the following at compile time:
</li></ul>
<pre> while (reader_obj.has_another)
   local var n = reader_obj.read
   ...
 endWhile
</pre>
<a name="Concurrent_Modification_Errors_and_RemoveCurrent" id="Concurrent_Modification_Errors_and_RemoveCurrent"></a><h2> <span class="mw-headline"> Concurrent Modification Errors and RemoveCurrent </span></h2>
<p>When working with <i>forEach</i> loops it's fairly easy to write code that generates a concurrent modification error.  This happens when you add elements to or remove elements from a list while still iterating through it.  For example:
</p>
<pre> forEach (index of active_list)
   local Entity entity = active_list[index]
   if (entity.is_dead) 
     active_list.remove(entity) 
     # This action causes a CME on the next iteration because the list structure
     # has changed between one iteration and the next!
   endIf
 endForEach
</pre>
<p>Concurrent Modification Errors can be frustrating but they help guard against logic errors.  Here are some design patterns to consider using if you want to add or remove list items while iterating.
</p>
<ul><li> If you want to add items while iterating - and possibly remove others - you can use two lists.  One list "alpha" contains your current bunch of items.  Another list "beta" starts out empty.  You copy any "surviving" alpha items as well as any new items to "beta", then swap the two lists.  An example:
</li></ul>
<pre> PROPERTIES
   alpha(), beta()&nbsp;: Entity[]
 ...
 forEach (entity in alpha)
   entity.update
   if (entity.still_alive) beta.add(entity)
   if (entity.firing) beta.add( Bullet() )
 endForEach
 local var temp = alpha
 alpha = beta
 beta = temp
 beta.clear
</pre>
<ul><li> If you only want to remove items, you could read from a read position, write to a write position, and skip the writing whenever you don't want to save an item.  After the loop is over you can discard the tail end of the list.  Example:
</li></ul>
<pre> local Int32 write_pos = 0
 forEach (read_pos of list)
   local var entity = list[read_pos]; read_pos++
   entity.update
   if (entity.still_alive) list[write_pos] = entity; write_pos++
 endForEach
 list.discard( read_pos )
</pre>
<ul><li> However, this can be a little tedious.  Slag's built-in removeCurrent command does the same thing as above and is much more convenient:
</li></ul>
<pre>     forEach (entity in list)
       entity.update
       if (not entity.still_alive) removeCurrent entity
     endForEac
</pre>
<ul><li> Note that the removeCurrent command only works with lists, not with other types of readers and readable objects.
</li></ul>

<!-- 
NewPP limit report
Preprocessor node count: 3/1000000
Post-expand include size: 0/2097152 bytes
Template argument size: 0/2097152 bytes
Expensive parser function count: 0/100
-->

<!-- Saved in parser cache with key pw_mediawiki_user:pcache:idhash:41-0!1!0!!en!2!edit=0 and timestamp 20120628114225 -->
<div class="printfooter">
Retrieved from "<a href="">http://www.plasmaworks.com/wiki/index.php/Slag:Advanced_ForEach</a>"</div>
						<!-- end content --><div class="visualClear"></div></div></div></div>
    <div id="column-one">
      <div id="p-cactions" class="portlet"></div>
      <div class="portlet" id="p-personal"></div>
      <div class="portlet" id="p-logo"></div>
      <div class="portlet" id="p-nav">
  
      </div>
      <div id="p-search" class="portlet"></div>
      <div class="portlet" id="p-tb"></div>
    </div>
    <!-- end left column -->
  <!-- end of the left (by default at least) column -->
			<div class="visualClear"></div>
			<div id="footerHacked">
				<ul id="f-list">
					<li id="lastmod"> This page was last modified on 20 March 2010, at 10:22.</li>
					<li id="viewcount">This page has been accessed 691 times.</li>
					<li id="privacy"><a href="plasmaworks_privacy_policy.html" title="Plasmaworks:Privacy policy">Privacy policy</a></li>
					<li id="about"><a href="plasmaworks_about.html" title="Plasmaworks:About">About Plasmaworks</a></li>
					<li id="disclaimer"><a href="plasmaworks_general_disclaimer.html" title="Plasmaworks:General disclaimer">Disclaimers</a></li>
			</ul>
		</div>
</div>

		<script type="text/javascript">if (window.runOnloadHook) runOnloadHook();</script>
<!-- Served in 0.253 secs. --><br></body></html>
